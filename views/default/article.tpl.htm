<?php 
$data = TPL::val('data');
$mpid = $data['mpid'];
$article = $data['article'];
$visitor = $data['visitor'];
$remarks = $article->remarks;
?> 
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"> 
        <meta content="width=device-width,user-scalable=no,initial-scale=1.0" name="viewport">
        <title><?php echo $article->title;?></title> 
        <link href="/static/css/bootstrap.min.css" rel="stylesheet">
        <?php $this->import_css('','article', true);?>
        <?php $body_css=TPL::val('body_css'); if (!empty($body_css)) {?>
        <style><?php echo $body_css;?></style> 
        <?php } ?>
        <?php if ($article->can_carousel === 'Y') {?>
        <link rel="stylesheet" type="text/css" href="/static/css/carousel.css"/>
        <?php } ?>
    </head>
    <body>
        <?php TPL::pt('body_ele');?>
        <div class="m-detail">
            <div class="wrap">
                <h1 class="tlt" id="title"><?php echo $article->title;?></h1>
                <div>
                    <span class="time"><?php echo date('Y-m-d', $article->modify_at);?></span> 
                    <?php if (TPL::val('yx_cardid')) {?>
                    <span id='article_from_nick'>
                        <a href="<?php echo 'yixin://opencard?pid='.TPL::val('yx_cardid');?>"><?php echo TPL::val('yx_cardname');?></a>
                    </span>
                    <?php } ?>
                </div>
                <?php if ($article->hide_pic === 'N' && !empty($article->pic)) {?>
                <div class="headpic"><img src="<?php echo $article->pic;?>"></div> 
                <?php } ?>
                <div class="content" id="content"></div>
                <?php if (!empty($article->url)) {?>
                <p class="url"><a href="<?php echo $article->url;?>" target="_self">阅读原文</a></p> 
                <?php } ?>
                <div id='interaction'>
                    <span class='read'><span>阅读</span><span id='readNum'><?php echo $article->readNum;?></span></span>
                    <span class='like'><em class="<?php echo $article->praised ? 'praised':'';?>" onclick='Like.change();'></em><span id='score'><?php echo $article->score;?></span></span>
                </div>
                <?php if ($remarks !== false) {?>
                <div class='remark clearfix'>
                    <h4>评论</h4>
                    <ul id='remarks'>
                        <?php 
                        foreach ($remarks as $r) {
                        $nickname = empty($r->nickname) ? strtok($r->email,'@'):$r->nickname;
                        $create_at = date('Y-m-d H:m', $r->create_at);
                        echo "<li><div>$r->remark</div><div class='clearfix'>
                            <div class='nickname'><span>发布者：</span>$nickname</div>
                            <div class='datetime'>$create_at</div>
                        </div></li>";
                        }
                        ?>
                    </ul>
                    <textarea id='newRemark' rows=4></textarea>
                    <button onclick='Remark.publish();'>发表评论</button>
                </div>
                <?php } ?>
            </div> 
        </div>
        <footer></footer>
        <div id='dlg'><div></div><button>关闭</button></div>
        <?php if ($article->can_picviewer === 'Y') {?>
        <div id='picViewer'><span>X</span><img/></div>
        <?php } ?>
        <iframe id='frmAuth'></iframe>
        <script type="text/javascript">
            window.mpid = '<?php echo $mpid;?>';
            window.article = <?php echo json_encode($article);?>; 
            window.visitor = <?php echo json_encode($visitor);?>; 
        </script>
        <?php if (preg_match('/MicroMessenger/i', $_SERVER['HTTP_USER_AGENT'])) {?>
        <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
        <script src="/rest/mi/matter/wxjssdksignpackage?mpid=<?php echo $mpid;?>&url=<?php echo urlencode("http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]");?>"></script>
        <?php } ?>
        <?php $this->import_js('','article', true);?>
        <?php if ($article->can_carousel === 'Y') {?>
        <script src="/static/js/swipeview.js"></script>
        <script src="/static/js/carousel.js"></script>
        <?php } ?>
        <?php if ($article->can_picviewer === 'Y') {?>
        <script src="/static/js/hammer.min.js"></script>
        <script src="/static/js/picViewer.js"></script>
        <script>
            window.addEventListener('load', supportPicviewer);
        </script>
        <?php } ?>
        <?php if (defined('SAE_MYSQL_HOST_M')) { ?>
        <script type="text/javascript">
            var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
            document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F40ec59c933400d729f57930675635edb' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <?php }?>
    </body>
</html>
